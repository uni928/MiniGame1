<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ•°å­—ãƒ‘ã‚ºãƒ«ï¼ˆå‹•ã‘ãªããªã£ãŸæ™‚ç‚¹ã§ãƒ™ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚Œã°ã‚¯ãƒªã‚¢ï¼ï¼‰</title>
  <style>
    body {
      background: #f2f2f2;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN", "Meiryo", sans-serif;
    }
    h2 { text-align: center; margin: 14px 0 6px; }
    #infobar { text-align: center; margin: 6px 0 12px; font-size: 16px; }
    .highlight { font-weight: 700; color: #0b3; }
    #controls { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin: 8px 0 12px;}
    .btn { padding:8px 12px; border:1px solid #ddd; border-radius:8px; background:#fff; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    table { border-collapse: collapse; margin: 8px auto; }
    td {
      width: 80px; height: 80px; border: 1px solid #ccc;
      text-align: center; vertical-align: middle; font-size: 18px;
      background: #fff; position: relative; user-select: none;
    }
    td.visited { background-color: #f3f3f3; }
    td.current { outline: 3px solid #3b82f6; }
    .step-number {
      position: absolute; top: 2px; right: 4px;
      font-size: 12px; color: darkred; font-weight: bold;
    }
    #answerPath { text-align:center; margin-top:8px; font-size: 20px; min-height: 28px; }
    #note { text-align:center; font-size: 13px; color:#666; margin-top: 6px; }
  </style>
</head>
<body>
  <h2>æ•°å­—ãƒ‘ã‚ºãƒ«ï¼ˆå‹•ã‘ãªããªã£ãŸæ™‚ç‚¹ã§ãƒ™ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚Œã°ã‚¯ãƒªã‚¢ï¼ï¼‰</h2>

  <div id="infobar">
    ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ï¼š<span id="cur" class="highlight">â€”</span> /
    ãƒ™ã‚¹ãƒˆï¼š<span id="best" class="highlight">â€”</span>
  </div>

  <div id="controls">
    <button class="btn" id="restartBtn">ğŸ” ãƒ—ãƒ¬ã‚¤ã‚’æœ€åˆã‹ã‚‰ï¼ˆåŒã˜ç›¤é¢ï¼‰</button>
    <button class="btn" id="newBoardBtn">ğŸ§© æ–°ã—ã„ç›¤é¢ã‚’ä½œã‚‹</button>
    <button class="btn" id="harderBtn">ğŸ‘‘ é«˜é›£æ˜“åº¦åŒ–</button>
    <button class="btn" id="resetBestBtn">ğŸ ãƒ™ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="btn" id="toggleAnswerBtn">ğŸ§  ç­”ãˆï¼ˆè¡¨ç¤º/éè¡¨ç¤ºï¼‰</button>
    <button class="btn" id="exportBtn">ğŸ“¤ ç›¤é¢ã‚’æ›¸ãå‡ºã™</button>
    <input type="file" id="importFile" accept=".txt" style="display:none">
    <button class="btn" id="importBtn">ğŸ“¥ ç›¤é¢ã‚’èª­ã¿è¾¼ã‚€</button>
  </div>

<label class="btn" style="display:inline-flex;align-items:center;gap:8px;">
  â³ åˆ¶é™æ™‚é–“
  <select id="timeLimitSelect">
    <option value="0">è¨­å®šãªã—</option>
    <option value="240">ãƒ™ãƒªãƒ¼ã‚¤ãƒ¼ã‚¸ãƒ¼ 240ç§’</option>
    <option value="120">ã‚¤ãƒ¼ã‚¸ãƒ¼ 120ç§’</option>
    <option value="80">ãƒãƒ¼ãƒãƒ« 80ç§’</option>
    <option value="50">ãƒãƒ¼ãƒ‰ 50ç§’</option>
    <option value="20">ãƒ™ãƒªãƒ¼ãƒãƒ¼ãƒ‰ 20ç§’</option>
    <option value="12">é‹ 12ç§’</option>
  </select>
</label>
<span id="timeLeft" style="min-width:110px;text-align:center;">æ®‹ã‚Šï¼šâ€”</span>


  <table id="grid"></table>
  <div id="answerPath"></div>
  <div id="note">â€» ã‚¯ãƒªãƒƒã‚¯ã§ä¸Šä¸‹å·¦å³æ–œã‚ã«1ãƒã‚¹ã ã‘ç§»å‹•ã§ãã¾ã™ï¼ˆ<b>ä¸€åº¦é€šã£ãŸãƒã‚¹ã¯å†è¨ªä¸å¯</b>ï¼‰ã€‚</div>

  <script>
    // ======= è¨­å®šãƒ»çŠ¶æ…‹ =======
    const size = 5;
    const dirs = [
      { dx: -1, dy: -1 }, { dx: 0, dy: -1 }, { dx: 1, dy: -1 },
      { dx: -1, dy: 0 },                    { dx: 1, dy: 0 },
      { dx: -1, dy: 1 }, { dx: 0, dy: 1 }, { dx: 1, dy: 1 },
    ];

    let grid = [], visited = [], start = {x:0,y:0}, pos = {x:0,y:0};
    let score = 10;
    let bestScore = -Infinity;
    let path = [];       // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆï¼ˆSTARTå«ã‚€ï¼‰
    let bestPath = [];   // ãƒ™ã‚¹ãƒˆæ›´æ–°æ™‚ã®ãƒ«ãƒ¼ãƒˆ
    let playerMode = false; // ãƒ—ãƒªã‚¦ã‚©ãƒ¼ã‚¯å¾Œã« true
    let showAnswerMode = false; // æœ€åˆã¯ç­”ãˆã‚’å‡ºã•ãªã„

    // ======= ç›¤é¢ç”Ÿæˆãƒ»æ¼”ç®— =======
    function generateCell() {
      const ops = ['+', '-', '*', '/'];
      const val = Math.floor(Math.random() * 9) + 1;
      const op = ops[Math.floor(Math.random() * ops.length)];
      return `${op}${val}`;
    }

    function applyOperation(value, operation) {
      const op = operation[0];
      const num = parseInt(operation.slice(1), 10);
      switch (op) {
        case '+': return value + num;
        case '-': return value - num;
        case '*': return value * num;
        case '/': return Math.floor(value / num);
        default:  return value;
      }
    }

    function calculateScoreFromPath(pathIn) {
      let temp = 10;
      for (let i=1;i<pathIn.length;i++) {
        const {x,y} = pathIn[i];
        const cell = grid[y][x];
        if (cell !== 'START') temp = applyOperation(temp, cell);
      }
      return temp;
    }

    function generateBoard() {
      grid = Array.from({length:size}, _ => Array(size).fill(''));
      visited = Array.from({length:size}, _ => Array(size).fill(false));
      // START ã‚’ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
      start = { x: Math.floor(Math.random()*size), y: Math.floor(Math.random()*size) };
      pos = { ...start };
      grid[start.y][start.x] = 'START';
      // ä»–ã¯æ¼”ç®—å­
      for (let y=0; y<size; y++) for (let x=0; x<size; x++) {
        if (grid[y][x] === '') grid[y][x] = generateCell();
      }
      score = 10;
      path = [{...pos}];
      visited[pos.y][pos.x] = true;
      bestScore = -Infinity;
      bestPath = [];
      playerMode = false;
      showAnswerMode = false; // æœ€åˆã¯ç­”ãˆéè¡¨ç¤º
      render();
      drawBest(); // showAnswerMode=false ãªã®ã§å®Ÿè³ªéè¡¨ç¤º
    }

    // ======= æç”» =======
    function render() {
      const table = document.getElementById('grid');
      table.innerHTML = '';
      for (let y=0; y<size; y++) {
        const tr = document.createElement('tr');
        for (let x=0; x<size; x++) {
          const td = document.createElement('td');
          td.dataset.xy = `${x},${y}`;
          td.textContent = grid[y][x];
          if (visited[y][x]) td.classList.add('visited');
          if (x===pos.x && y===pos.y) td.classList.add('current');
          td.addEventListener('click', () => playerMove(x, y));
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
      document.getElementById('cur').textContent = score;
      document.getElementById('best').textContent = (bestScore===-Infinity ? 'â€”' : bestScore);

      // ç­”ãˆè¡¨ç¤ºã®ã‚ªãƒ³/ã‚ªãƒ•åæ˜ 
      if (showAnswerMode) drawBest(); else clearBestOverlay();
    }

    function clearBestOverlay() {
      document.querySelectorAll('td').forEach(td => {
        td.style.backgroundColor = '';
        const label = td.querySelector('.step-number');
        if (label) label.remove();
      });
      document.getElementById('answerPath').textContent = '';
    }

    function getArrow(dx, dy) {
      if (dx === -1 && dy === 0) return "â¬…ï¸";
      if (dx ===  1 && dy === 0) return "â¡ï¸";
      if (dx ===  0 && dy ===-1) return "â¬†ï¸";
      if (dx ===  0 && dy === 1) return "â¬‡ï¸";
      if (dx === -1 && dy ===-1) return "â†–";
      if (dx ===  1 && dy ===-1) return "â†—";
      if (dx === -1 && dy === 1) return "â†™";
      if (dx ===  1 && dy === 1) return "â†˜";
      return "â“";
    }

    function drawBest() {
      clearBestOverlay();
      if (!showAnswerMode) return;               // éè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ãªã‚‰æã‹ãªã„
      if (!bestPath || bestPath.length === 0) return;

      // çµŒè·¯ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼†é€šéé †ç•ªå·ï¼ˆ0=STARTï¼‰
      for (let i=0;i<bestPath.length;i++) {
        const p = bestPath[i];
        const td = document.querySelector(`td[data-xy='${p.x},${p.y}']`);
        if (!td) continue;
        td.style.backgroundColor = "#cde";
        const label = document.createElement('div');
        label.className = "step-number";
        label.textContent = i;
        td.appendChild(label);
      }

      // çŸ¢å°åˆ—ï¼ˆ5å€‹ã”ã¨ã«å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‰
      const arrows = [];
      for (let i=1;i<bestPath.length;i++) {
        const dx = bestPath[i].x - bestPath[i-1].x;
        const dy = bestPath[i].y - bestPath[i-1].y;
        arrows.push(getArrow(dx,dy));
      }
      const spaced = arrows.reduce((acc,cur,idx)=>{
        acc += cur;
        if ((idx+1)%5===0 && idx!==arrows.length-1) acc += "ã€€";
        return acc;
      },"");
      document.getElementById('answerPath').textContent = spaced;
    }

    // ======= ãƒ©ãƒ³ãƒ€ãƒ ã‚¦ã‚©ãƒ¼ã‚¯ï¼ˆãƒ—ãƒªã‚¦ã‚©ãƒ¼ã‚¯ç”¨ãƒ»æç”»ãªã—ï¼‰ =======
 function stepOnceCore() {
   const moves = dirs
     .map(d => ({ x: pos.x + d.dx, y: pos.y + d.dy }))
     .filter(p => p.x>=0 && p.x<size && p.y>=0 && p.y<size && !visited[p.y][p.x]);

   if (moves.length === 0) {
    // è¡Œãæ­¢ã¾ã‚Šï¼ˆãƒ—ãƒªã‚¦ã‚©ãƒ¼ã‚¯ã®ã€Œã‚¯ãƒªã‚¢ã€ç›¸å½“ï¼‰â†’ ãƒ™ã‚¹ãƒˆæ›´æ–°åˆ¤å®šã—ã¦ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ
    if (score > bestScore) {
      bestScore = score;
      bestPath = path.map(p=>({x:p.x,y:p.y}));
    }
     visited = Array.from({length:size}, _ => Array(size).fill(false));
     pos = { ...start };
     score = 10;
     path = [{...pos}];
     visited[pos.y][pos.x] = true;
     return;
   }

   const next = moves[Math.floor(Math.random()*moves.length)];
   visited[next.y][next.x] = true;

   const cell = grid[next.y][next.x];
   if (cell !== 'START') score = applyOperation(score, cell);

   pos = next;
   path.push({...pos});

  // æ¬¡ã®æ‰‹ãŒãªã‘ã‚Œã°ã€Œè¡Œãæ­¢ã¾ã‚Šã€â†’ ãã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã®ã¿ãƒ™ã‚¹ãƒˆåˆ¤å®š
  const nextMoves = dirs
    .map(d => ({ x: pos.x + d.dx, y: pos.y + d.dy }))
    .filter(p => p.x>=0 && p.x<size && p.y>=0 && p.y<size && !visited[p.y][p.x]);
  if (nextMoves.length === 0) {
    if (score > bestScore) {
      bestScore = score;
      bestPath = path.map(p=>({x:p.x,y:p.y}));
    }
    // è¡Œãæ­¢ã¾ã‚Šå¾Œã¯å³ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ—ãƒªã‚¦ã‚©ãƒ¼ã‚¯ç¶™ç¶šï¼‰
    visited = Array.from({length:size}, _ => Array(size).fill(false));
    pos = { ...start };
    score = 10;
    path = [{...pos}];
    visited[pos.y][pos.x] = true;
  }
 }


    function prewalk(steps = 30000) {
      for (let i=0; i<steps; i++) stepOnceCore();
    }

    // ======= ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œï¼ˆã‚¯ãƒªãƒƒã‚¯ç§»å‹•ï¼‰ =======
function playerMove(x, y) {
  if (!playerMode) return;               // ãƒ—ãƒ¬ã‚¦ã‚©ãƒ¼ã‚¯ä¸­ã¯ç„¡è¦–
  if (visited[y][x]) return;              // å†è¨ªä¸å¯
  const dx = Math.abs(x - pos.x), dy = Math.abs(y - pos.y);
  if (dx > 1 || dy > 1 || (dx === 0 && dy === 0)) return; // 8æ–¹å‘ç§»å‹•ã®ã¿

  // ç§»å‹•å‡¦ç†
  visited[y][x] = true;
  const cell = grid[y][x];
  if (cell !== 'START') score = applyOperation(score, cell);

  pos = { x, y };
  path.push({ ...pos });
  render();
  if (showAnswerMode) drawBest();

  // æ¬¡ã®æ‰‹ãŒã‚ã‚‹ã‹ç¢ºèª
  const nextMoves = dirs
    .map(d => ({ x: pos.x + d.dx, y: pos.y + d.dy }))
    .filter(p => p.x >= 0 && p.x < size && p.y >= 0 && p.y < size && !visited[p.y][p.x]);

  // è¡Œãæ­¢ã¾ã‚Šæ™‚ã®ã¿ãƒ™ã‚¹ãƒˆæ›´æ–°ï¼†ã‚¯ãƒªã‚¢æ‰±ã„
  if (nextMoves.length === 0) {
    const wasImproved = (score >= bestScore);
    const oldBestScore = bestScore;
    if (wasImproved) {
      bestScore = score;
      bestPath = path.map(p => ({ x: p.x, y: p.y }));
      if (showAnswerMode) drawBest();
      render();
    }

    if(wasImproved) {
       if (timeLimitSec > 0 && remainingSec > 0) {
         clearCountdown();
       }
    }

    alert(
      wasImproved
        ? `ğŸ‰ ã‚¯ãƒªã‚¢ï¼\nã‚¹ã‚³ã‚¢: ${score}ï¼ˆãƒ™ã‚¹ãƒˆ: ${oldBestScore}ï¼‰`
        : `ğŸ§© å¤±æ•—â€¦\nã‚¹ã‚³ã‚¢: ${score}ï¼ˆãƒ™ã‚¹ãƒˆ: ${oldBestScore}ï¼‰`
    );
  }
}




    // ======= ç›¤é¢ã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥å‡ºåŠ› =======
    function exportToTxt() {
      const lines = [];
      lines.push(`START:${start.x},${start.y}`);
      lines.push('GRID:');
      for (let y=0; y<size; y++) {
        lines.push(grid[y].join(','));
      }
      lines.push('BESTPATH:');
      for (const p of bestPath) {
        lines.push(`${p.x},${p.y}`);
      }

      const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'puzzle_nogoal.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importFromTxt(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const lines = e.target.result.trim().split('\n');
        const startLine = lines[0].replace('START:', '').split(',').map(Number);
        const gridStartIndex = lines.findIndex(l => l.startsWith('GRID:')) + 1;
        const bestPathStartIndex = lines.findIndex(l => l.startsWith('BESTPATH:')) + 1;

        // GRID å¾©å…ƒ
        grid = [];
        for (let y=0; y<size; y++) {
          grid[y] = lines[gridStartIndex + y].split(',');
        }

        // STARTãƒ»åˆæœŸåŒ–
        start = { x: startLine[0], y: startLine[1] };
        pos = { ...start };
        visited = Array.from({length:size}, _ => Array(size).fill(false));
        visited[pos.y][pos.x] = true;
        score = 10;

        // BESTPATH å¾©å…ƒ
        bestPath = [];
        if (bestPathStartIndex > 0) {
          for (let i = bestPathStartIndex; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || !line.includes(',')) continue;
            const [x, y] = line.split(',').map(Number);
            if (!isNaN(x) && !isNaN(y)) bestPath.push({x,y});
          }
        }

        // ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢ã¯ä¿å­˜ã—ãªã„æ–¹é‡ â†’ é€†ç®—
        bestScore = bestPath.length ? calculateScoreFromPath(bestPath) : -Infinity;

        // çŠ¶æ…‹
        path = [{...pos}];
        playerMode = true;          // ã™ããƒ—ãƒ¬ã‚¤å¯èƒ½ã«
        showAnswerMode = false;     // èª­ã¿è¾¼ã¿ç›´å¾Œã¯ç­”ãˆéè¡¨ç¤º
        render();
        drawBest();
      };
      reader.readAsText(file);
    }

    // ======= ãƒœã‚¿ãƒ³ =======
    document.getElementById('restartBtn').addEventListener('click', () => {
      // åŒã˜ç›¤é¢ã§ START ã‹ã‚‰å†ãƒ—ãƒ¬ã‚¤ï¼ˆãƒ™ã‚¹ãƒˆã¯ä¿æŒï¼‰
      visited = Array.from({length:size}, _ => Array(size).fill(false));
      pos = { ...start };
      score = 10;
      path = [{...pos}];
      visited[pos.y][pos.x] = true;
      playerMode = true;
      render();
      if (showAnswerMode) drawBest();
    });

    document.getElementById('newBoardBtn').addEventListener('click', () => {
      generateBoard();
      // æ–°ã—ã„ç›¤é¢ã‚’ç”Ÿæˆ â†’ å†ã³5000æ­©ãƒ—ãƒªã‚¦ã‚©ãƒ¼ã‚¯ â†’ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–‹å§‹
      prewalk(500000);
      playerMode = true;
      render();
      if (showAnswerMode) drawBest();

      // åŒã˜ç›¤é¢ã§ START ã‹ã‚‰å†ãƒ—ãƒ¬ã‚¤ï¼ˆãƒ™ã‚¹ãƒˆã¯ä¿æŒï¼‰
      visited = Array.from({length:size}, _ => Array(size).fill(false));
      pos = { ...start };
      score = 10;
      path = [{...pos}];
      visited[pos.y][pos.x] = true;
      playerMode = true;
      render();
      if (showAnswerMode) drawBest();
      startCountdownIfNeeded();
    });

    document.getElementById('resetBestBtn').addEventListener('click', () => {
      bestScore = -Infinity;
      bestPath = [];
      if (showAnswerMode) drawBest(); else clearBestOverlay();
      render();
    });

    document.getElementById('toggleAnswerBtn').addEventListener('click', () => {
      showAnswerMode = !showAnswerMode;
      if (showAnswerMode) drawBest(); else clearBestOverlay();
    });

    document.getElementById('exportBtn').addEventListener('click', exportToTxt);
    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importFile').click();
    });
    document.getElementById('importFile').addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) importFromTxt(e.target.files[0]);
      e.target.value = '';
    });

    // ======= åˆæœŸåŒ–ï¼šç›¤é¢â†’5000æ­©ãƒ—ãƒªã‚¦ã‚©ãƒ¼ã‚¯â†’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–‹å§‹ =======
    generateBoard();
    prewalk(500000);
    playerMode = true;
    render();

function setBusy(busy, msg = "é«˜é›£æ˜“åº¦åŒ–ä¸­â€¦") {
  const ids = ["restartBtn","newBoardBtn","resetBestBtn","toggleAnswerBtn","exportBtn","importBtn","harderBtn"];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = !!busy;
  });
  const info = document.getElementById("infobar");
  if (!info) return;
  if (busy) {
    const cur = document.getElementById("cur")?.textContent ?? "â€”";
    const best = document.getElementById("best")?.textContent ?? "â€”";
    info.innerHTML = `ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ï¼š<span id="cur" class="highlight">${cur}</span> /
      ãƒ™ã‚¹ãƒˆï¼š<span id="best" class="highlight">${best}</span>ã€€<span style="margin-left:8px;color:#444">${msg}</span>`;
  } else {
    info.innerHTML = `ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ï¼š<span id="cur" class="highlight">${score}</span> /
      ãƒ™ã‚¹ãƒˆï¼š<span id="best" class="highlight">${bestScore===-Infinity?'â€”':bestScore}</span>`;
  }
}

function runHardSearch(iterations = 4000000) {
  // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚’æ±šã•ãªã„ï¼‰
  let v = Array.from({length:size}, _ => Array(size).fill(false));
  let p = { ...start };
  let sc = 10;
  let pathLocal = [{...p}];

  v[p.y][p.x] = true;

  let localBestScore = -Infinity;
  let localBestPath = [];

  for (let i = 0; i < iterations; i++) {
    // å‘¨å›²ã®æœªè¨ªå•
    const moves = dirs
      .map(d => ({ x: p.x + d.dx, y: p.y + d.dy }))
      .filter(q => q.x>=0 && q.x<size && q.y>=0 && q.y<size && !v[q.y][q.x]);

    if (moves.length === 0) {
      // è¡Œãæ­¢ã¾ã‚Š â†’ ã“ã“ã§ã®ã¿ãƒ™ã‚¹ãƒˆæ›´æ–°
      if (sc > localBestScore) {
        localBestScore = sc;
        localBestPath = pathLocal.map(t => ({x:t.x, y:t.y}));
      }
      // åŒã˜ç›¤é¢ã§ START ã«æˆ»ã—ã¦ç¶šè¡Œ
      v = Array.from({length:size}, _ => Array(size).fill(false));
      p = { ...start };
      sc = 10;
      pathLocal = [{...p}];
      v[p.y][p.x] = true;
      continue;
    }

    // 1æ‰‹é€²ã‚€
    const nx = moves[Math.floor(Math.random()*moves.length)];
    v[nx.y][nx.x] = true;

    const cell = grid[nx.y][nx.x];
    if (cell !== 'START') sc = applyOperation(sc, cell);

    p = nx;
    pathLocal.push({...p});

    // â€» ãƒ™ã‚¹ãƒˆæ›´æ–°ã¯ã—ãªã„ï¼ˆè¡Œãæ­¢ã¾ã‚Šæ™‚ã®ã¿ï¼‰
  }

  return { score: localBestScore, path: localBestPath };
}

function harder() {
  setBusy(true);
  // å°‘ã—å¾…ã£ã¦UIã‚’æ›´æ–°ã—ã¦ã‹ã‚‰é‡ã„å‡¦ç†ã‚’é–‹å§‹
  setTimeout(() => {
    const result = runHardSearch(4000000); // 400ä¸‡å›
    let msg;
    if (result.score > bestScore) {
      bestScore = result.score;
      bestPath = result.path;
      msg = `ğŸ’ª é«˜é›£æ˜“åº¦åŒ–æˆåŠŸï¼æ–°ã—ã„ãƒ™ã‚¹ãƒˆã¯ ${bestScore} ã§ã™ã€‚`;
    } else {
      msg = `ğŸ™… é«˜é›£æ˜“åº¦åŒ–ã®çµæœã€ãƒ™ã‚¹ãƒˆã¯æ›´æ–°ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆç¾çŠ¶: ${bestScore===-Infinity?'â€”':bestScore}ï¼‰ã€‚`;
    }
    setBusy(false);
    render();
    if (showAnswerMode) drawBest();
    alert(msg);
    startCountdownIfNeeded();
  }, 50);
}

document.getElementById('harderBtn').addEventListener('click', harder);

// === ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ ===
let timeLimitSec = 0;      // ã‚»ãƒ¬ã‚¯ãƒˆã®è¨­å®šç§’æ•°ï¼ˆ0=ãªã—ï¼‰
let remainingSec = 0;      // æ®‹ã‚Šç§’
let countdownId = null;    // setInterval ãƒãƒ³ãƒ‰ãƒ«

function updateTimeLeftLabel() {
  const el = document.getElementById('timeLeft');
  if (!el) return;
  el.textContent = timeLimitSec > 0 ? `æ®‹ã‚Šï¼š${remainingSec}s` : 'æ®‹ã‚Šï¼šâ€”';
}

function clearCountdown() {
  if (countdownId) {
    clearInterval(countdownId);
    countdownId = null;
  }
}

function startCountdownIfNeeded() {
  clearCountdown();
  if (timeLimitSec <= 0) { remainingSec = 0; updateTimeLeftLabel(); return; }
  remainingSec = timeLimitSec;
  updateTimeLeftLabel();
  countdownId = setInterval(() => {
    remainingSec = Math.max(remainingSec - 1, 0);
    updateTimeLeftLabel();
    if (remainingSec <= 0) {
      clearCountdown();
      alert('â° åˆ¶é™æ™‚é–“ã«ãªã‚Šã¾ã—ãŸï¼ã“ã®ã¾ã¾ç¶šã‘ã¦ãƒ—ãƒ¬ã‚¤ã§ãã¾ã™ã€‚');
      // ã‚¿ã‚¤ãƒãƒ¼ã¯æ­¢ã‚ã‚‹ã ã‘ï¼ˆãƒ—ãƒ¬ã‚¤ã¯ç¶™ç¶šå¯ï¼‰
    }
  }, 1000);
}

// åˆ¶é™æ™‚é–“ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´
document.getElementById('timeLimitSelect').addEventListener('change', (e) => {
  timeLimitSec = parseInt(e.target.value, 10) || 0;
  // ãƒ—ãƒ¬ã‚¤ä¸­ã«å¤‰æ›´ã•ã‚ŒãŸã‚‰ã€ã“ã“ã§ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã›ãšæ–°è¨­å®šã§å³å†ã‚«ã‚¦ãƒ³ãƒˆé–‹å§‹
  startCountdownIfNeeded();
});




    // åŒã˜ç›¤é¢ã§ START ã‹ã‚‰å†ãƒ—ãƒ¬ã‚¤ï¼ˆãƒ™ã‚¹ãƒˆã¯ä¿æŒï¼‰
      visited = Array.from({length:size}, _ => Array(size).fill(false));
      pos = { ...start };
      score = 10;
      path = [{...pos}];
      visited[pos.y][pos.x] = true;
      playerMode = true;
      render();
      if (showAnswerMode) drawBest();
      startCountdownIfNeeded();
  </script>
</body>
</html>
